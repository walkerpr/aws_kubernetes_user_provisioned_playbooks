---
- name: Create content & directory
  ansible.builtin.file:
    state: directory
    path: /root/.kube
    mode: '0644'

- name: Write kubeadmin file to localhost
  ansible.builtin.copy:
    mode: preserve
    src: "/etc/kubernetes/admin.conf"
    dest: "/root/.kube/config"
    remote_src: true


- name: Copy kubeadmin file data
  ansible.builtin.slurp:
    src: /etc/kubernetes/admin.conf
  register: kubeadmin


- name: Write kubeadmin file to localhost
  ansible.builtin.copy:
    mode: preserve
    content: "{{ kubeadmin.content | b64decode }}"
    dest: "/home/ec2-user/.kube/deployment{{ deployment_number }}-kub.conf"
  delegate_to: localhost


- name: Recursively change ownership of a file
  ansible.builtin.file:
    path: "/home/ec2-user/.kube/deployment{{ deployment_number }}-kub.conf"
    state: file
    owner: ec2-user
    ansible.builtin.group: ec2-user
  delegate_to: localhost

- name: Get the current caller identity information
  changed_when: caller_info.rc != 0
  ansible.builtin.shell: aws sts get-caller-identity --query Account --output text
  register: caller_info
  delegate_to: localhost

- name: Upload kube file to s3
  register: my_output
  changed_when: my_output.rc != 0
  ansible.builtin.shell: aws s3 cp /home/ec2-user/.kube/deployment{{ deployment_number }}-kub.conf s3://sample-{{ caller_info.stdout }}-kub/deployment{{ deployment_number }}/kube/config
  delegate_to: localhost
