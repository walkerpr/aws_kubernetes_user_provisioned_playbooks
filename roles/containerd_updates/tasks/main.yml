---
# tasks file for sample-containerd-updates
- name: Update Containerd Config Path
  ansible.builtin.lineinfile:
    path: /etc/containerd/config.toml
    line: '      config_path = "/etc/containerd/certs.d"'
    insertafter: '    [plugins."io.containerd.grpc.v1.cri".registry]'
    regexp: '      config_path = ""'
    state: present

- name: Create containerd certs.d directory
  ansible.builtin.file:
    path: /etc/containerd/certs.d
    state: directory
    mode: '0755'

- name: Create sample registry certs.d directory
  ansible.builtin.file:
    path: "/etc/containerd/certs.d/{{ sample_kub_fqdn }}"
    state: directory
    mode: '0755'

- name: Copy over sample cert for containerd
  ansible.builtin.copy:
    src: "/opt/k8s-csr/pki/{{ sample_kub_fqdn}}.crt"
    dest: "/etc/containerd/certs.d/{{ sample_kub_fqdn }}/client.cert"
    remote_src: true

- name: Copy over sample key for contaienerd
  ansible.builtin.copy:
    src: "/opt/k8s-csr/pki/{{ sample_kub_fqdn }}.key"
    dest: "/etc/containerd/certs.d/{{ sample_kub_fqdn }}/client.key"
    remote_src: true

- name: Copy CA bundle for containerd
  ansible.builtin.copy:
    src: "/etc/pki/ca-trust/source/anchors/cabundle.crt"
    dest: "/etc/containerd/certs.d/{{ sample_kub_fqdn }}/ca.crt"
    remote_src: true

- name: Add kub sample registry hosts.toml
  ansible.builtin.template:
    src: "samplearty.toml.j2"
    dest: "/etc/containerd/certs.d/{{ sample_kub_fqdn }}/hosts.toml"
    owner: root
    ansible.builtin.group: root
    mode: '0644'

- name: Restart Containerd service
  ansible.builtin.systemd_service:
    name: containerd
    state: restarted

- name: Restart Kubelet service
  ansible.builtin.systemd_service:
    name: kubelet
    state: restarted
    daemon_reload: true
    daemon_reexec: true